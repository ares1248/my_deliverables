<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, maximum-scale=1.0">
<title>ito - Candy Pop</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ito App">
<link rel="apple-touch-icon" href="https://img.icons8.com/color/512/board-game.png">
<link rel="icon" href="https://img.icons8.com/color/512/board-game.png">

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Nunito:wght@600;800&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-gradient: linear-gradient(135deg, #ff9ecb, #8fdcff);
    --btn-gradient: linear-gradient(135deg, #ff7fbd, #7fd8ff);
    --panel-bg: rgba(255, 255, 255, 0.2);
    --text-color: #fff;
    --card-back: repeating-linear-gradient(45deg, #ff9ecb, #ff9ecb 10px, #ffb3d9 10px, #ffb3d9 20px);
  }

  body.dark-mode {
    --bg-gradient: linear-gradient(135deg, #1a1a2e, #16213e);
    --btn-gradient: linear-gradient(135deg, #4e4376, #2b5876);
    --panel-bg: rgba(0, 0, 0, 0.4);
    --card-back: repeating-linear-gradient(45deg, #2b5876, #2b5876 10px, #4e4376 10px, #4e4376 20px);
  }

  body {
    font-family: 'M PLUS Rounded 1c', 'Nunito', sans-serif;
    background: var(--bg-gradient); color: var(--text-color);
    text-align: center; padding: 20px 15px; font-size: 18px; min-height: 100vh;
    box-sizing: border-box; user-select: none; transition: all 0.5s ease;
    margin: 0; padding-top: max(20px, env(safe-area-inset-top));
  }

  #stickyTopic {
    position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7);
    padding: 8px; padding-top: max(8px, env(safe-area-inset-top)); font-weight: bold; font-size: 16px; z-index: 50; display: none;
    backdrop-filter: blur(5px); color: #fff; border-bottom: 2px solid rgba(255,255,255,0.2);
  }

  h1 { font-size: 32px; font-weight: 800; margin: 20px 0; text-shadow: 0 3px 6px rgba(0,0,0,0.2); }

  button {
    font-family: inherit; font-size: 18px; padding: 12px 24px; margin: 6px;
    border: none; border-radius: 50px; background: var(--btn-gradient); color: #fff;
    box-shadow: 0 5px 0 rgba(0,0,0,0.2); transition: transform 0.1s; cursor: pointer; font-weight: bold;
    white-space: nowrap;
  }
  button:active { transform: translateY(4px); box-shadow: none; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  button.secondary { background: #fff; color: #ff7fbd; }
  body.dark-mode button.secondary { background: #2b5876; color: #fff; }

  .del-topic-btn { background: #ff4b82; font-size: 12px; padding: 5px 10px; border-radius: 8px; display: none; margin-left: 5px; }

  .game-section { background: var(--panel-bg); border-radius: 20px; padding: 20px 15px; margin: 20px auto; max-width: 500px; backdrop-filter: blur(5px); }

  .card-container { perspective: 1000px; margin: 30px auto; width: 220px; height: 280px; position: relative; }
  #resultCard {
    width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
    transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1); border-radius: 20px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer;
  }
  .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  .card-front { background: #fff; color: #ff5fa8; transform: rotateY(0deg); }
  .card-front .number { font-size: 90px; font-weight: 800; }
  .card-back { background: var(--card-back); transform: rotateY(180deg); border: 4px solid #fff; display: flex; justify-content: center; align-items: center; }
  .tap-text {
    color: #fff;
    font-size: 36px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    opacity: 0.8;
    pointer-events: none;
    animation: pulse 1.5s infinite;
    line-height: 1;
    margin: 0;
    padding: 0;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
  }
  #resultCard.is-hidden { transform: rotateY(180deg); }

  @keyframes shake { 0% { transform: translate(0,0); } 25% { transform: translate(2px,2px); } 50% { transform: translate(-2px,0); } 75% { transform: translate(2px,-2px); } 100% { transform: translate(0,0); } }
  .shaking { animation: shake 0.1s infinite; }

  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; backdrop-filter: blur(3px); }
  .modal-content { background: var(--bg-gradient); margin: 30px auto; padding: 25px; width: 85%; max-width: 400px; border-radius: 25px; border: 4px solid #fff; max-height: 80vh; overflow-y: auto; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

  .tag-btn { background: #fff; color: #ff7fbd; border-radius: 15px; padding: 5px 12px; font-size: 14px; margin: 4px; display: inline-block; cursor: pointer; font-weight: bold; position: relative; }
  .delete-btn { background: #ff4b82; color: #fff; border-radius: 5px; padding: 2px 6px; margin-left: 5px; font-size: 12px; }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .reset-btn { background: #ff6b6b; color: #fff; font-size: 14px; padding: 8px 16px; border-radius: 20px; position: fixed; top: max(60px, env(safe-area-inset-top) + 45px); right: 15px; z-index: 100; box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
  .reset-btn:active { transform: scale(0.95); }

  @media (max-width: 430px) {
    body { padding: 15px 10px; font-size: 16px; }
    h1 { font-size: 28px; margin: 15px 0; }
    .game-section { padding: 15px 10px; margin: 15px auto; }
    button { font-size: 16px; padding: 10px 20px; margin: 5px; }
    .card-container { width: 200px; height: 260px; }
    .card-front .number { font-size: 80px; }
    #topicDisplay { font-size: 20px; padding: 12px; }
    .reset-btn { font-size: 12px; padding: 6px 12px; top: max(55px, env(safe-area-inset-top) + 40px); right: 10px; }
  }

  select, input { font-size: 18px; padding: 12px; margin: 8px; border-radius: 12px; border: 2px solid #fff; background: rgba(255,255,255,0.9); width: 85%; color: #333; }
</style>
</head>
<body>

<div id="stickyTopic">ãŠé¡Œ: <span id="currentTopicLabel">---</span></div>

<h1>ito <span id="themeEmoji">ğŸ¬</span></h1>

<div style="margin-bottom:10px;">
  <button id="themeToggleBtn" class="secondary" style="font-size:14px; padding:8px 15px;">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
  <button id="openHistoryBtn" class="secondary" style="font-size:14px; padding:8px 15px;">ğŸ“œ å±¥æ­´</button>
</div>

<div id="setupArea" class="game-section">
  <select id="categorySelect">
    <option value="">ã‚«ãƒ†ã‚´ãƒªé¸æŠ</option>
    <option value="popularity">â­ï¸ äººæ°—ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
    <option value="entertainment">ğŸ® ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ»ã‚­ãƒ£ãƒ©</option>
    <option value="food">ğŸ± é£Ÿã¹ç‰©ãƒ»é£²ã¿ç‰©</option>
    <option value="life">ğŸ  ç”Ÿæ´»ãƒ»å ´æ‰€</option>
    <option value="love">ğŸ’˜ æ‹æ„›ãƒ»äººé–“é–¢ä¿‚</option>
    <option value="fantasy">ğŸ§ª ã‚‚ã—ã‚‚ãƒ»ç©ºæƒ³</option>
    <option value="power">ğŸ’ª å¼·ã•ãƒ»å¤§ãã•</option>
    <option value="emotion">âœ¨ æ„Ÿæ€§ãƒ»è¨€è‘‰</option>
    <option value="custom">âœï¸ ã‚«ã‚¹ã‚¿ãƒ </option>
  </select>

  <div id="customTopicInputArea" style="display:none; margin: 10px 0;">
    <input id="newTopicInput" type="text" placeholder="è‡ªä½œãŠé¡Œã‚’å…¥åŠ›">
    <button id="addTopicBtn" style="padding: 10px 20px;">è¿½åŠ </button>
  </div>

  <div style="display:flex; align-items:center; justify-content:center;">
    <select id="topicSelect" style="width:70%;"></select>
    <button id="deleteTopicBtn" class="del-topic-btn">å‰Šé™¤</button>
  </div>

  <div style="margin: 5px 0;">
    <button id="randomTopicBtn" class="secondary" style="font-size:14px; padding:8px 16px;">ğŸ² ãŠé¡Œã‚¹ãƒ­ãƒƒãƒˆ</button>
  </div>

  <div id="topicDisplay" style="font-size:22px; margin:15px 0; font-weight:bold; padding:15px; background:rgba(255,255,255,0.1); border-radius:10px; min-height: 1.5em; display: flex; align-items: center; justify-content: center;">ãŠé¡Œã‚’é¸ã‚“ã§ãã ã•ã„</div>

  <div id="countInputArea">
    <input id="playerCountInput" type="number" min="2" max="20" value="3" style="width:60px;"> äºº
    <button id="gotoNamesBtn">æ¬¡ã¸</button>
  </div>

  <div id="nameArea" style="display:none;"></div>
</div>

<div id="playerArea" class="game-section" style="display:none; transition: opacity 0.3s;">
  <h2 id="playerLabel"></h2>
  <div class="card-container">
    <div id="resultCard" class="is-hidden">
      <div class="card-face card-front"><div class="number" id="numberDisplay">?</div></div>
      <div class="card-face card-back">
        <div class="tap-text">ã‚¿ãƒƒãƒ—</div>
      </div>
    </div>
  </div>
  <button id="nextPlayerBtn">ç¢ºèªã—ã¾ã—ãŸ</button>
</div>

<div id="orderArea" class="game-section" style="display:none;">
  <div style="margin-bottom:15px;">
    <button id="remindBtn" class="secondary" style="font-size:14px;">ğŸ‘ æ•°å­—ã‚’å†ç¢ºèª</button>
  </div>
  <div id="orderButtons" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
  <div id="selectedOrderDisplay" style="font-size:18px; margin:15px 0; min-height:1.5em; background:rgba(0,0,0,0.1); padding:10px; border-radius:10px;"></div>
  <button id="undoBtn" class="secondary">1ã¤æˆ»ã™</button>
  <hr>
  <div id="judgeConfirmArea">
    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
      <label style="font-weight: bold; display: flex; align-items: center; white-space: nowrap;"><input type="checkbox" id="readyCheck" style="margin-right: 8px;"> æº–å‚™OKï¼Ÿ</label>
    </div>
    <button id="judgeBtn" style="margin-top:10px;">åˆ¤å®šã™ã‚‹ï¼</button>
  </div>
  <div id="judgeResult" style="margin-top:20px; font-size:20px;"></div>
  <div id="replayArea" style="display:none; margin-top:20px;">
    <div style="margin-bottom:10px;">
      <button id="replayBtn">ã‚‚ã†ä¸€åº¦ï¼ˆåŒã˜ãƒ¡ãƒ³ãƒãƒ¼ï¼‰</button>
      <button id="changeTopicBtn" class="secondary" style="font-size:14px; padding:8px 16px;">ğŸ“ ãŠé¡Œã‚’å¤‰æ›´</button>
    </div>
    <button id="homeBtn" class="secondary">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
  </div>
</div>

<div id="nextModal" class="modal"><div class="modal-content"><h2 id="nextPlayerNameDisplay"></h2><p>ä»–ã®äººã«è¦‹ã‚‰ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã­</p><button id="nextOkBtn">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button></div></div>
<div id="remindModal" class="modal"><div class="modal-content"><h3>ã‚ãªãŸã®æ•°å­—</h3><h1 id="remindNum" style="font-size:80px; color:#ff5fa8; margin:20px 0;">?</h1><p>æŒ‡ã‚’é›¢ã™ã¨éš ã‚Œã¾ã™</p></div></div>
<div id="alertModal" class="modal"><div class="modal-content"><h3 id="alertTitle">ç¢ºèª</h3><p id="alertMessage"></p><button onclick="this.closest('.modal').style.display='none'">OK</button></div></div>
<div id="historyModal" class="modal"><div class="modal-content"><h2>ã“ã‚Œã¾ã§ã®è¨˜éŒ²</h2><div style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: center;"><button class="closeModal">é–‰ã˜ã‚‹</button><button id="clearHistoryBtn" style="background: #ff4444; color: #fff;">å±¥æ­´ã‚’ä¸€æ‹¬å‰Šé™¤</button></div><div id="historyList"></div></div></div>

<button id="resetBtn" class="reset-btn" style="display: none;" onclick="confirmReset()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>

<script>
const topics = {
  popularity: ["ã‚³ãƒ³ãƒ“ãƒ‹ã®äººæ°—", "100å‡ã®äººæ°—", "é£²é£Ÿåº—ã®äººæ°—", "å­ä¾›ã«äººæ°—ãªã‚‚ã®", "ãŠåœŸç”£ã®äººæ°—", "æœ‰åäººã®äººæ°—", "ä¹—ã‚Šç‰©ã®äººæ°—", "ã‚¹ãƒãƒ¼ãƒ„ã®äººæ°—"],
  entertainment: ["ã‚¢ãƒ‹ãƒ¡ã‚­ãƒ£ãƒ©ã®äººæ°—", "ã‚²ãƒ¼ãƒ ã®äººæ°—", "å£°å„ªã®äººæ°—", "æ˜ ç”»ã®äººæ°—", "ç«¥è©±ã®äººæ°—", "ãªã‚ŠãŸã„ã‚­ãƒ£ãƒ©", "æ‚ªå½¹ã®äººæ°—"],
  food: ["ä¸­è¯æ–™ç†ã®äººæ°—", "çµ¦é£Ÿã®äººæ°—", "ãŠè“å­ã®äººæ°—", "ãŠã«ãã‚Šã®å…·ã®äººæ°—", "ãƒ‘ãƒ³ã®äººæ°—", "å’Œé£Ÿã®äººæ°—", "é…’ã®ã¤ã¾ã¿ã®äººæ°—"],
  life: ["ä½ã¿ãŸã„å ´æ‰€", "è¶£å‘³ã®äººæ°—", "è³‡æ ¼ã®äººæ°—", "æ—…è¡Œã—ãŸã„å›½", "ä¸€äººæš®ã‚‰ã—ã«å¿…è¦ãªã‚‚ã®", "ã‚«ãƒãƒ³ã®ä¸­èº«ã®é‡è¦åº¦"],
  love: ["æ‹äººã«ã—ãŸã„è·æ¥­", "ãƒ‡ãƒ¼ãƒˆã‚¹ãƒãƒƒãƒˆã®äººæ°—", "ãƒ¢ãƒ†ã‚‹ç‰¹æŠ€", "ã‚°ãƒƒã¨ãã‚‹ä»•è‰", "çµå©šã—ãŸã„æœ‰åäºº", "ãƒ—ãƒ­ãƒãƒ¼ã‚ºã®è¨€è‘‰"],
  fantasy: ["ã‚¾ãƒ³ãƒ“æˆ¦ã®æ­¦å™¨", "ç„¡äººå³¶ã«æŒã¤ã‚‚ã®", "ãªã‚ŠãŸã„ç”Ÿãç‰©", "å®‡å®™äººã¸ã®ãŠåœŸç”£", "æ¬²ã—ã„ç‰¹æ®Šèƒ½åŠ›", "æ­´å²ä¸Šã®äººç‰©"],
  power: ["æ­´å²äººç‰©ã®å¼·ã•", "ç”Ÿãç‰©ã®å¼·ã•", "ã‚¢ãƒ‹ãƒ¡ã‚­ãƒ£ãƒ©ã®å¼·ã•", "ç”Ÿãç‰©ã®å¤§ãã•", "æœ‰åäººã®å¹´å", "é‡ãã†ãªã‚‚ã®"],
  emotion: ["ç¾ã—ã„ã‚‚ã®", "æ€–ã„ã‚‚ã®", "æ¥½ã—ã„ã“ã¨", "å¬‰ã—ã„è¨€è‘‰", "å¼·ãã†ãªè¨€è‘‰", "ã‚«ãƒƒã‚³ã„ã„è‹—å­—", "äººç”Ÿã§å¤§åˆ‡ãªã‚‚ã®"],
  custom: JSON.parse(localStorage.getItem("itoCustomTopics") || "[]")
};

let gameState = {
  names: [], players: [], currentPlayerIndex: 0, selectedOrder: [],
  savedNames: JSON.parse(localStorage.getItem("itoPersistentNames") || "[]"),
  gameHistory: JSON.parse(localStorage.getItem("itoGameHistory") || "[]"),
  cardTapped: {}
};

const topicDisp = document.getElementById("topicDisplay");

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(type) {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  const now = audioCtx.currentTime;
  switch(type) {
    case 'success': osc.frequency.setValueAtTime(880, now); gain.gain.setValueAtTime(0.3, now); osc.start(); osc.stop(now + 0.5); break;
    case 'fail': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.3, now); osc.start(); osc.stop(now + 0.5); break;
    case 'pop': osc.frequency.setValueAtTime(500, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.1); gain.gain.setValueAtTime(0.3, now); osc.start(); osc.stop(now + 0.1); break;
    case 'tick': osc.frequency.setValueAtTime(1200, now); gain.gain.setValueAtTime(0.05, now); osc.start(); osc.stop(now + 0.02); break;
  }
}

function showAlert(message, title = "ç¢ºèª") {
  document.getElementById("alertTitle").textContent = title;
  document.getElementById("alertMessage").textContent = message;
  document.getElementById("alertModal").style.display = "block";
}

function showConfirm(message, callback) {
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.style.display = "block";
  modal.innerHTML = `
    <div class="modal-content">
      <h3>ç¢ºèª</h3>
      <p>${message}</p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="this.closest('.modal').remove(); if(window._confirmCallback) window._confirmCallback(true);" style="background: #4CAF50; color: white;">ã¯ã„</button>
        <button onclick="this.closest('.modal').remove(); if(window._confirmCallback) window._confirmCallback(false);" style="background: #666; color: white;">ã„ã„ãˆ</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  window._confirmCallback = (result) => {
    callback(result);
    delete window._confirmCallback;
  };
}

document.getElementById("openHistoryBtn").onclick = () => {
  const historyList = document.getElementById("historyList");
  if(gameState.gameHistory.length === 0) {
    historyList.innerHTML = "<p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>";
  } else {
    historyList.innerHTML = gameState.gameHistory.map((game, index) => `
      <div style="background: rgba(255,255,255,0.1); padding: 10px; margin: 5px 0; border-radius: 10px; text-align: left;">
        <div style="font-weight: bold; margin-bottom: 5px;">${game.date}</div>
        <div style="margin-bottom: 3px;"><strong>ãŠé¡Œ:</strong> ${game.topic}</div>
        <div style="margin-bottom: 3px;"><strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:</strong> ${game.players.map(p => p.name+'('+p.number+')').join(', ')}</div>
        <div style="margin-bottom: 3px;"><strong>é¸ã‚“ã é †:</strong> ${game.selectedOrder.join(' â†’ ')}</div>
        <div style="margin-bottom: 3px;"><strong>æ­£è§£:</strong> ${game.correctOrder.join(' â†’ ')}</div>
        <div style="color: ${game.isSuccess ? '#4CAF50' : '#FF6B6B'}; font-weight: bold;">
          ${game.isSuccess ? 'ğŸ‰ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼' : 'ğŸ˜¢ ã‚ºãƒ¬æŒ‡æ•°: ' + game.gap}
        </div>
        <button onclick="deleteHistory(${index})" style="font-size: 12px; padding: 4px 8px; margin-top: 5px; background: #ff4444;">å‰Šé™¤</button>
      </div>
    `).join('');
  }
  document.getElementById("historyModal").style.display="block";
  playTone('pop');
};

document.getElementById("gotoNamesBtn").onclick = () => {
  const count = parseInt(document.getElementById("playerCountInput").value);
  if(count < 2 || count > 20) return showAlert("äººæ•°ã¯2ã€œ20äººã§é¸ã‚“ã§ãã ã•ã„");
  showNameInputs(count);
};

function deleteHistory(index) {
  showConfirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', (result) => {
    if(result) {
      gameState.gameHistory.splice(index, 1);
      localStorage.setItem("itoGameHistory", JSON.stringify(gameState.gameHistory));
      document.getElementById("openHistoryBtn").click(); // å†èª­ã¿è¾¼ã¿
      playTone('pop');
    }
  });
}

function clearAllHistory() {
  showConfirm('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚', (result) => {
    if(result) {
      gameState.gameHistory = [];
      localStorage.setItem("itoGameHistory", JSON.stringify(gameState.gameHistory));
      document.getElementById("openHistoryBtn").click(); // å†èª­ã¿è¾¼ã¿
      playTone('pop');
    }
  });
}

function showNameInputs(count) {
  nameArea.innerHTML = "<h4>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆé‡è¤‡ä¸å¯ï¼‰</h4>";
  const savedDiv = document.createElement("div");
  savedDiv.style.maxHeight = "120px";
  savedDiv.style.overflowY = "auto";
  gameState.savedNames.forEach(n => {
    const s = document.createElement("span"); s.className="tag-btn"; s.textContent = n;
    s.onclick = () => { 
        const inps = Array.from(document.querySelectorAll(".p-name"));
        if(inps.some(i => i.value === n)) return showAlert("åŒã˜åå‰ã¯æ—¢ã«å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™");
        const empty = inps.find(i => !i.value); 
        if(empty) empty.value = n; 
    };
    const x = document.createElement("span"); x.className="delete-btn"; x.textContent="Ã—"; 
    x.onclick=(e)=>{ e.stopPropagation(); gameState.savedNames=gameState.savedNames.filter(name=>name!==n); localStorage.setItem("itoPersistentNames", JSON.stringify(gameState.savedNames)); document.getElementById("gotoNamesBtn").click(); };
    s.appendChild(x); savedDiv.appendChild(s);
  });
  nameArea.appendChild(savedDiv);
  for(let i=0; i<count; i++) {
    const inp = document.createElement("input"); inp.className="p-name"; inp.placeholder=`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i+1}`;
    inp.style.width="80%"; nameArea.appendChild(inp);
  }
  const b = document.createElement("button"); b.textContent = "ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã§é–‹å§‹ï¼"; b.onclick = initGame;
  nameArea.appendChild(b); nameArea.style.display="block";
  document.getElementById("countInputArea").style.display="none";
  playTone('pop');
}

function initGame() {
  const topic = topicDisp.textContent;
  if(topic.includes("é¸ã‚“ã§")) return showAlert("ãŠé¡Œã‚’æ±ºã‚ã¦ãã ã•ã„");
  const inps = Array.from(document.querySelectorAll(".p-name"));
  const inputNames = inps.map((inp, i) => inp.value.trim() || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i+1}`);
  if(new Set(inputNames).size !== inputNames.length) return showAlert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚");

  gameState.names = inputNames;
  gameState.names.forEach(n => { if(!gameState.savedNames.includes(n)) gameState.savedNames.push(n); });
  localStorage.setItem("itoPersistentNames", JSON.stringify(gameState.savedNames));

  gameState.players = Array.from({length: 100}, (_, i) => i+1).sort(()=>Math.random()-0.5).slice(0, gameState.names.length);
  gameState.currentPlayerIndex = 0;
  gameState.selectedOrder = [];
  gameState.cardTapped = {};
  
  document.getElementById("setupArea").style.display="none";
  document.getElementById("playerArea").style.display="block";
  document.getElementById("stickyTopic").style.display="block";
  document.getElementById("currentTopicLabel").textContent = topic;
  document.getElementById("resetBtn").style.display="block";
  document.getElementById("selectedOrderDisplay").textContent = "";
  preparePlayer();
}

function preparePlayer() {
  document.getElementById("resultCard").classList.add("is-hidden");
  document.getElementById("numberDisplay").textContent = "?";
  document.getElementById("playerArea").style.opacity = "0";
  document.getElementById("playerLabel").textContent = `${gameState.names[gameState.currentPlayerIndex]} ã•ã‚“ã®ç•ª`;
  document.getElementById("nextPlayerNameDisplay").textContent = `æ¬¡ã¯ ${gameState.names[gameState.currentPlayerIndex]} ã•ã‚“`;
  document.getElementById("nextModal").style.display="block";
  document.getElementById("judgeConfirmArea").style.display="none";
}

document.getElementById("nextOkBtn").onclick = () => {
  document.getElementById("nextModal").style.display="none";
  document.getElementById("playerArea").style.opacity = "1";
  let count = 0;
  document.getElementById("resultCard").classList.add("shaking");
  const timer = setInterval(() => {
    document.getElementById("numberDisplay").textContent = Math.floor(Math.random()*100)+1;
    playTone('tick');
    if(count++ > 12) {
      clearInterval(timer);
      document.getElementById("numberDisplay").textContent = gameState.players[gameState.currentPlayerIndex];
      document.getElementById("resultCard").classList.remove("shaking");
      playTone('pop');
    }
  }, 60);
};

document.getElementById("resultCard").onclick = () => { 
  const currentPlayer = gameState.names[gameState.currentPlayerIndex];
  if(!gameState.cardTapped[currentPlayer]) {
    gameState.cardTapped[currentPlayer] = true;
    document.getElementById("resultCard").classList.toggle("is-hidden");
    playTone('pop');
  }
};
document.getElementById("nextPlayerBtn").onclick = () => {
  const currentPlayer = gameState.names[gameState.currentPlayerIndex];
  if(!gameState.cardTapped[currentPlayer]) {
    showAlert("ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ•°å­—ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
    return;
  }
  gameState.currentPlayerIndex++;
  if(gameState.currentPlayerIndex >= gameState.names.length) {
    document.getElementById("playerArea").style.display="none";
    document.getElementById("orderArea").style.display="block";
    document.getElementById("judgeConfirmArea").style.display="block";
    document.getElementById("resultCard").classList.add("is-hidden");
    renderOrderButtons();
  } else { preparePlayer(); }
};

document.getElementById("remindBtn").onclick = () => {
  const modal = document.getElementById("remindModal");
  const modalContent = modal.querySelector(".modal-content");
  
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠè‚¢ã‚’ä½œæˆ
  modalContent.innerHTML = `
    <h3>èª°ã®æ•°å­—ã‚’ç¢ºèªã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
      ${gameState.names.map((name, index) => 
        `<button onclick="showPlayerNumber(${index})" style="padding: 10px; margin: 5px 0; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">${name}</button>`
      ).join('')}
    </div>
    <button onclick="this.closest('.modal').style.display='none'" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
  `;
  
  modal.style.display = "block";
};

function showPlayerNumber(index) {
  const modal = document.getElementById("remindModal");
  const modalContent = modal.querySelector(".modal-content");
  
  // æ•°å­—è¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å†æ§‹ç¯‰
  modalContent.innerHTML = `
    <h3>${gameState.names[index]}ã•ã‚“ã®æ•°å­—</h3>
    <h1 id="remindNum" style="font-size:80px; color:#ff5fa8; margin:20px 0;">${gameState.players[index]}</h1>
    <button onclick="showRemindPlayerList()" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">æˆ»ã‚‹</button>
  `;
}

function showRemindPlayerList() {
  const modal = document.getElementById("remindModal");
  const modalContent = modal.querySelector(".modal-content");
  
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠè‚¢ã«æˆ»ã‚‹
  modalContent.innerHTML = `
    <h3>èª°ã®æ•°å­—ã‚’ç¢ºèªã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
      ${gameState.names.map((name, index) => 
        `<button onclick="showPlayerNumber(${index})" style="padding: 10px; margin: 5px 0; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">${name}</button>`
      ).join('')}
    </div>
    <button onclick="this.closest('.modal').style.display='none'" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
  `;
}

function renderOrderButtons() {
  const container = document.getElementById("orderButtons");
  container.innerHTML = "";
  gameState.names.forEach((n, i) => {
    const b = document.createElement("button"); b.textContent = n;
    b.disabled = gameState.selectedOrder.includes(i);
    b.onclick = () => { gameState.selectedOrder.push(i); renderOrderButtons(); updateOrderUI(); playTone('pop'); };
    container.appendChild(b);
  });
}
function updateOrderUI() { 
  const display = document.getElementById("selectedOrderDisplay");
  if(gameState.selectedOrder.length === 0) {
    display.textContent = "";
  } else {
    display.textContent = gameState.selectedOrder.map(i => gameState.names[i]).join(" â†’ ");
  }
}
document.getElementById("undoBtn").onclick = () => { gameState.selectedOrder.pop(); renderOrderButtons(); updateOrderUI(); };

document.getElementById("judgeBtn").onclick = () => {
  if(!document.getElementById("readyCheck").checked) return showAlert("æº–å‚™ãŒã§ããŸã‚‰ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã­ï¼");
  if(gameState.selectedOrder.length < gameState.names.length) return showAlert("å…¨å“¡é¸ã‚“ã§ã­");
  const correct = gameState.players.map((num, i) => ({num, i})).sort((a,b)=>a.num-b.num).map(o => o.i);
  const isSuccess = JSON.stringify(gameState.selectedOrder) === JSON.stringify(correct);
  let gap = 0;
  gameState.selectedOrder.forEach((pIdx, idx) => { gap += Math.abs(gameState.players[pIdx] - gameState.players[correct[idx]]); });
  
  // å±¥æ­´ã«ä¿å­˜
  const gameResult = {
    date: new Date().toLocaleString('ja-JP'),
    topic: document.getElementById("currentTopicLabel").textContent,
    players: gameState.names.map((name, i) => ({name, number: gameState.players[i]})),
    selectedOrder: gameState.selectedOrder.map(i => gameState.names[i]),
    correctOrder: correct.map(i => gameState.names[i]),
    isSuccess: isSuccess,
    gap: gap
  };
  gameState.gameHistory.unshift(gameResult);
  if(gameState.gameHistory.length > 50) gameState.gameHistory.pop(); // æœ€å¤§50ä»¶
  localStorage.setItem("itoGameHistory", JSON.stringify(gameState.gameHistory));
  
  document.getElementById("judgeResult").innerHTML = (isSuccess ? "ğŸ‰ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼" : "ğŸ˜¢ ã‚ºãƒ¬ã¡ã‚ƒã„ã¾ã—ãŸ") + `<br>ã‚ºãƒ¬æŒ‡æ•°: ${gap}<br><small>æ­£è§£: ${correct.map(i => gameState.names[i]+'('+gameState.players[i]+')').join('â†’')}</small>`;
  document.getElementById("judgeConfirmArea").style.display="none";
  document.getElementById("replayArea").style.display="block";
  playTone(isSuccess ? 'success' : 'fail');
};

document.getElementById("replayBtn").onclick = () => {
  gameState.selectedOrder = [];
  document.getElementById("judgeResult").innerHTML = "";
  document.getElementById("judgeConfirmArea").style.display="none";
  document.getElementById("replayArea").style.display="none";
  document.getElementById("readyCheck").checked = false;
  document.getElementById("selectedOrderDisplay").textContent = "";
  document.getElementById("orderArea").style.display="none";
  initGame();
};

document.getElementById("changeTopicBtn").onclick = () => {
  gameState.selectedOrder = [];
  document.getElementById("judgeResult").innerHTML = "";
  document.getElementById("orderArea").style.display="none";
  document.getElementById("setupArea").style.display="block";
  document.getElementById("countInputArea").style.display="none";
  document.getElementById("nameArea").style.display="block";
  document.getElementById("replayArea").style.display="none";
  document.getElementById("readyCheck").checked = false;
  document.getElementById("selectedOrderDisplay").textContent = "";
  document.getElementById("judgeConfirmArea").style.display="block";
  
  // æ—¢å­˜ã®ã€Œã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã§é–‹å§‹ï¼ã€ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
  const startBtn = document.querySelector("#nameArea button[onclick='initGame()']");
  if(startBtn) {
    startBtn.textContent = "ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ï¼";
  }
  
  playTone('pop');
};

document.getElementById("homeBtn").onclick = () => {
  gameState.selectedOrder = [];
  document.getElementById("judgeResult").innerHTML = "";
  document.getElementById("orderArea").style.display = "none";
  document.getElementById("setupArea").style.display = "block";
  document.getElementById("countInputArea").style.display = "block";
  document.getElementById("nameArea").style.display = "none";
  document.getElementById("stickyTopic").style.display = "none";
  document.getElementById("judgeConfirmArea").style.display = "block";
  document.getElementById("replayArea").style.display = "none";
  document.getElementById("resetBtn").style.display="none";
  playTone('pop');
};

function confirmReset() {
  showConfirm('ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã¾ã™ã€‚', (result) => {
    if(result) {
      document.getElementById("resetBtn").style.display="none";
      document.getElementById("homeBtn").click();
    }
  });
}

document.getElementById("clearHistoryBtn").onclick = clearAllHistory;

document.querySelectorAll(".closeModal").forEach(b => b.onclick = () => b.closest(".modal").style.display="none");

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.querySelectorAll(".modal").forEach(modal => {
  modal.onclick = (e) => {
    if(e.target === modal) {
      modal.style.display = "none";
      // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å ´åˆã¯ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
      if(modal.id === "nextModal") {
        document.getElementById("playerArea").style.opacity = "1";
        let count = 0;
        document.getElementById("resultCard").classList.add("shaking");
        const timer = setInterval(() => {
          document.getElementById("numberDisplay").textContent = Math.floor(Math.random()*100)+1;
          playTone('tick');
          if(count++ > 12) {
            clearInterval(timer);
            document.getElementById("numberDisplay").textContent = gameState.players[gameState.currentPlayerIndex];
            document.getElementById("resultCard").classList.remove("shaking");
            playTone('pop');
          }
        }, 60);
      }
      playTone('pop');
    }
  };
});

// åˆæœŸåŒ–å‡¦ç†
function init() {
  const categorySelect = document.getElementById("categorySelect");
  const topicSelect = document.getElementById("topicSelect");
  const customTopicInputArea = document.getElementById("customTopicInputArea");
  const newTopicInput = document.getElementById("newTopicInput");
  const addTopicBtn = document.getElementById("addTopicBtn");
  const deleteTopicBtn = document.getElementById("deleteTopicBtn");
  const randomTopicBtn = document.getElementById("randomTopicBtn");
  const themeToggleBtn = document.getElementById("themeToggleBtn");
  
  // ã‚«ãƒ†ã‚´ãƒªé¸æŠæ™‚ã®å‡¦ç†
  categorySelect.onchange = () => {
    const category = categorySelect.value;
    topicSelect.innerHTML = "<option value=''>ãŠé¡Œã‚’é¸æŠ</option>";
    customTopicInputArea.style.display = category === "custom" ? "block" : "none";
    
    if(category && topics[category]) {
      topics[category].forEach(topic => {
        const option = document.createElement("option");
        option.value = topic;
        option.textContent = topic;
        topicSelect.appendChild(option);
      });
    }
  };
  
  // ãŠé¡Œé¸æŠæ™‚ã®å‡¦ç†
  topicSelect.onchange = () => {
    if(topicSelect.value) {
      topicDisp.textContent = topicSelect.value;
      playTone('pop');
    }
  };
  
  // ã‚«ã‚¹ã‚¿ãƒ ãŠé¡Œè¿½åŠ 
  addTopicBtn.onclick = () => {
    const topic = newTopicInput.value.trim();
    if(topic && !topics.custom.includes(topic)) {
      topics.custom.push(topic);
      localStorage.setItem("itoCustomTopics", JSON.stringify(topics.custom));
      
      const option = document.createElement("option");
      option.value = topic;
      option.textContent = topic;
      topicSelect.appendChild(option);
      
      newTopicInput.value = "";
      playTone('pop');
    }
  };
  
  // ãŠé¡Œå‰Šé™¤
  deleteTopicBtn.onclick = () => {
    if(categorySelect.value === "custom" && topicSelect.value) {
      const index = topics.custom.indexOf(topicSelect.value);
      if(index !== -1) {
        topics.custom.splice(index, 1);
        localStorage.setItem("itoCustomTopics", JSON.stringify(topics.custom));
        topicSelect.remove(topicSelect.selectedIndex);
        topicDisp.textContent = "ãŠé¡Œã‚’é¸ã‚“ã§ãã ã•ã„";
        playTone('pop');
      }
    }
  };
  
  // ãƒ©ãƒ³ãƒ€ãƒ ãŠé¡Œ
  randomTopicBtn.onclick = () => {
    const category = categorySelect.value;
    let availableTopics = [];
    
    if(category && topics[category]) {
      // é¸æŠä¸­ã®ã‚«ãƒ†ã‚´ãƒªå†…ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
      availableTopics = topics[category];
    } else {
      // ã‚«ãƒ†ã‚´ãƒªæœªé¸æŠæ™‚ã¯å…¨ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
      availableTopics = Object.values(topics).flat();
    }
    
    if(availableTopics.length === 0) {
      showAlert("ãŠé¡ŒãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    
    const button = document.getElementById("randomTopicBtn");
    button.disabled = true;
    button.textContent = "ğŸ° ã‚¹ãƒ­ãƒƒãƒˆå›è»¢ä¸­...";
    
    let counter = 0;
    const maxCount = 20;
    const interval = setInterval(() => {
      const randomTopic = availableTopics[Math.floor(Math.random() * availableTopics.length)];
      topicDisp.textContent = randomTopic;
      document.getElementById("currentTopicLabel").textContent = randomTopic;
      playTone('tick');
      
      counter++;
      if(counter >= maxCount) {
        clearInterval(interval);
        const finalTopic = availableTopics[Math.floor(Math.random() * availableTopics.length)];
        topicDisp.textContent = finalTopic;
        document.getElementById("currentTopicLabel").textContent = finalTopic;
        
        // æ±ºå®šæ¼”å‡º
        topicDisp.style.animation = "none";
        setTimeout(() => {
          topicDisp.style.animation = "pulse 0.5s ease-in-out 3";
          topicDisp.style.background = "linear-gradient(45deg, #FFD700, #FFA500)";
          topicDisp.style.color = "#fff";
          topicDisp.style.fontWeight = "bold";
          topicDisp.style.fontSize = "26px";
        }, 10);
        
        setTimeout(() => {
          topicDisp.style.animation = "";
        }, 2000);
        
        button.disabled = false;
        button.textContent = "ğŸ² ãŠé¡Œã‚¹ãƒ­ãƒƒãƒˆ";
        playTone('success');
      }
    }, 100);
  };
  
  // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
  themeToggleBtn.onclick = () => {
    document.body.classList.toggle("dark-mode");
    playTone('pop');
  };
}

// DOMèª­ã¿è¾¼ã¿å¾Œã«åˆæœŸåŒ–
if(document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
</script>
</body>
</html>
